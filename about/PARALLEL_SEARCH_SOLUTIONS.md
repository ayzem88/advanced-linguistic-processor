# حلول مشكلة "unable to open database" في البحث المتوازي

## المشكلة
عند البحث المتكرر، يظهر خطأ "unable to open database file" بسبب محاولة فتح اتصالات متعددة متزامنة.

---

## الحلول المقترحة

### ✅ الحل 1: تحسين إعدادات PRAGMA (الأسرع - 5 دقائق)

**الإعدادات المطلوبة:**
```python
PRAGMA journal_mode = WAL          # موجود ✓
PRAGMA synchronous = NORMAL        # جديد
PRAGMA cache_size = -64000         # 64 MB
PRAGMA temp_store = MEMORY         # استخدام الذاكرة
PRAGMA mmap_size = 268435456       # 256 MB
```

**المزايا:**
- سرعة كاملة (4 خيوط)
- استقرار أفضل
- تطبيق بسيط

**التطبيق:**
فقط إضافة الإعدادات في `database.py`

---

### ✅ الحل 2: Connection Pool مع SQLAlchemy (احترافي - يوم)

**الفكرة:**
استخدام مكتبة تدير الاتصالات بذكاء وتعيد استخدامها.

**المكتبة:**
```bash
pip install sqlalchemy
```

**المزايا:**
- استقرار 100%
- يدعم 10+ خيوط
- إدارة تلقائية للاتصالات

**السلبيات:**
- يحتاج تعديل أكبر في الكود
- مكتبة إضافية

---

### ✅ الحل 3: Read-Only Mode (أبسط - 10 دقائق)

**الفكرة:**
فتح القواعد بوضع القراءة فقط أثناء البحث.

**التطبيق:**
```python
sqlite3.connect('file:path/to/db?mode=ro', uri=True)
```

**المزايا:**
- قراءات متزامنة غير محدودة
- سرعة فائقة
- لا أخطاء

**السلبيات:**
- للقراءة فقط (لا كتابة أثناء البحث)

---

### ✅ الحل 4: الوضع الحالي (2 خيوط - يعمل)

**ما تم:**
- تقليل الخيوط من 4 إلى 2
- timeout=30
- check_same_thread=False

**المزايا:**
- يعمل بدون أخطاء
- بسيط

**السلبيات:**
- أبطأ ~1 ثانية من 4 خيوط

---

## التوصيات

| الحل | الوقت | السرعة | الاستقرار | التعقيد |
|------|-------|--------|-----------|---------|
| 1. PRAGMA | 5 دقائق | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐ |
| 2. Connection Pool | يوم | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| 3. Read-Only | 10 دقائق | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐ |
| 4. الحالي (2 خيوط) | جاهز | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐ |

---

## الخلاصة

**الأفضل للسرعة والبساطة:** الحل 1 (PRAGMA)  
**الأفضل للاستقرار:** الحل 2 (Connection Pool)  
**الأسرع تطبيقاً:** الحل 3 (Read-Only)  
**يعمل حالياً:** الحل 4 (2 خيوط)

---

**تاريخ:** أكتوبر 8، 2025
